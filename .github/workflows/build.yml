name: CI/CD Pipeline

on:
    push:
        branches:
            - 'prod'
    pull_request:
        branches: ['prod']

jobs:
    docker:
        name: Docker Build and Push
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v3

            - name: Login to Docker Hub
              uses: docker/login-action@v1
              with:
                  username: ${{ secrets.DOCKER_HUB_USERNAME }}
                  password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Build and push BE
              uses: docker/build-push-action@v3
              with:
                  context: ./
                  file: ./Dockerfile
                  push: true
                  tags: ${{ secrets.DOCKER_HUB_USERNAME }}/blog:latest
            - name: AWS SSM Send-Command
              uses: peterkimzz/aws-ssm-send-command@v1.1.1
              with:
                  # AWS access key id
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  # AWS secret access key
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: ${{ secrets.AWS_REGION }}
                  # AWS EC2 Instance id
                  instance-ids: ${{ secrets.AWS_INSTANCE_ID }}
                  # Command execution location
                  working-directory: /home/ubuntu
                  command: |
                      sudo docker-compose stop
                      sudo docker-compose rm -f
                      sudo docker-compose pull
                      sudo docker-compose up -d
                      sudo docker image prune -af
                  # Comment for Send-Command
                  comment: 'Deploying the latest version of the app'
